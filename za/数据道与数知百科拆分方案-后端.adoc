= 数据道与数知百科拆分方案--后端

== 拆分需求及目标

*关于验证码在redis中缓存的key和次数的确定，待重构时再讨论*

. 两个产品从运行环境及数据存储位置两方面完全隔离(运行配置不同)；
. 产品功能上暂时保持一致，不做删减及修改(功能部分的代码两者相同)；
. 两个产品共享同一套用户系统。其中，用户的ID及登录所需信息二者共享，用户名称、头像等基本设置二者单独拥有。

== 现有实现分析

=== 运行配置

. 不同的运行及存储环境需要不同的运行及数据库配置。当前的项目中通过一个环境变量在代码中“手动”从配置文件中读取配置，
同类型的配置均存在了一个文件中，各部分配置的存取方式也不尽相同。当前实现下，增加一套新的“环境”需要修改的位置很多，系统容易出错。

=== 用户系统

. 当前的用户系统可大致分为三个部分：基本用户信息、注册登录模块、消息发送模块。
.. 基本用户信息：包含用户名、昵称、简介、头像、状态配置等。这些信息多用于显示及一些业务判断。
.. 注册登录模块：用户可用手机号、邮箱、微信等方式注册，登录。其中微信登录包括从不同的公众号、扫二维码登录，前提是这些公众号都关联到了我们的开放平台下。
.. 消息发送模块：向手机发送各类短信，向邮箱发送各类邮件，向微信发送通知。

. 用户系统包含：
.. 两个mysql表，保存用户信息、相应微信ID等信息；
.. 一个solr-cole，保存用户基本信息，用于筛选及搜索；
.. redis中有保存用户信息的session；

----
  根据需求，需要对当前的mysql表进行拆分，并把注册登录、消息发送的功能进行抽象提取。
----

=== 现有微信各类平台总结

.开放平台下资源
|====
|类型|名称|当前作用位置
|移动应用|数据排行|
|网站应用|数据道|使用微信帐号登录App或者网站，pc/手机网页版微信登录
|公众号(服务号)|数据道|数据道微信版入口
|公众号(服务号)|数据道应用|为数据道第三方应用提供服务,启明、新明阳眼镜店系统入口
|====

.非开放平台下的资源
救援队、清真寺、明星小程序


== 实现方案

=== 运行配置(已实现)

. 通过spring-profile-active环境变量参数从不同的配置文件中读取相同类型的配置，并在gradle的打包任务中修改保存这个变量的文件。
. mybatis使用springboot框架的自动化配置，删除原有对于mybatis-bean创建的代码，在配置文件中加入所需的配置参数。

=== 用户系统

  从整体上看，用户系统的基本信息模块由各个应用单独实现，注册登录模块、消息发送模块在一个新的项目中实现，两个应用通过远程调用的方式实现这些功能。

==== 公共用户功能系统

1.数据库表设计

.基础登录方式表
|====
|id|userId|account/username|password|phone|email|createTime
|自增主键|24位用户ID|账号(用户名)|密码|手机号|邮箱|创建时间
|====

.开放平台微信信息表(由unionId唯一确定一个用户)
|====
|id|userId|wechatName|unionId|appId|openId
|自增主键|24位用户ID|绑定的微信用户名|当前微信用户在开放平台下的unionId，唯一标示该用户|微信定义的appId，不用公众号不同|当前微信用户在指定appId下的openId，唯一标示该用户
|====

.未绑定在开放平台下其他微信应用对应用户信息表(由appId+openId唯一确定一个用户)
|====
|id|userId|wechatName|appId|openId
|自增主键|24位用户ID|绑定的微信用户名|微信定义的appId，不用公众号不同|当前微信用户在指定appId下的openId，唯一标示该用户
|====

a.根据微信现有的逻辑，各个ID之间的逻辑如下:
----
微信用户 <---> 开放平台a:唯一unionId <---> (开放平台a:appId1)-openId
                                  <---> (开放平台a下的公众平台b:appId2)-openId
                                  <---> (开放平台a下的公众平台c:appId3)-openId
----
b.在与微信的交互中，通过传入appId,可以得到当前微信用户的openId或unionId，通过table2/table3可以查询到用户的ID。

2.功能设计

* 查询

1).根据账号/手机号/email获取用户ID；

2).根据用户ID，获取用户的所有登录用信息；(手机号、账号、email、绑定的微信号-需要在两个表中查询)

* 增删改：

1).新增一个用带有账号的用户;

2).新增一个从微信登录的用户，记录其appId，同步初始化一个账号;

3).根据userId更新绑定的邮箱、手机号、微信信息

* 功能性接口:

1).发送短信，并记录发送的日志

2).发送邮件，并记录发送日志

3).账号/手机号/email登录；
   a.入参为account(account/phone/email)及passwd；
   b.登录成功，返回用户id;
   c.登录失败，返回用户不存在/密码错误

* 微信相关:

1).微信分享时获取签名

由/dbc/api/wechat/sign移至这里

2).微信登录用于重定向后调用的接口:

  a.根据请求的客户端类型返回不同的回调url

  b.从参数state中读取appId,通过APPID读取要回调的url

3).微信登录验证或注册(开放平台下)

  input:获取微信授权流程第一步中获得的验证码code，appId。
  process:
    a.通过appId在系统中获取secretKey,向微信请求accessToken，及openId；
    b.在user_wechat表中通过appId,openId查询用户是否已经存在；若存在，则返回用户存在及用户的ID；若不存在，继续；
    c.通过accessToken及openId获取微信用户信息，包含unionId.
    d.在user_wechat表中通过unionId查询用户是否已经存在；
      若存在，则在表中插入openId-appId-unionId-userId这一条新数据，表示该用户在该途径下通过微信登录初始化过。后返回用户存在及用户的ID。
      若不存在，说明用户从未登录过，进行用户创建流程。后返回用户新创建及用户的ID、微信头像、昵称等信息.

4).微信登录验证或注册(非开放平台下)

  input:获取微信授权流程第一步中获得的验证码code，appId。
  process:
    a.通过appId在系统中获取secretKey,向微信请求accessToken，及openId；
    b.在user_wechat表中通过appId,openId查询用户是否已经存在；若存在，则返回用户存在及用户的ID；
      若不存在，说明用户从未登录过，进行用户创建流程。后返回用户新创建及用户的ID、微信头像、昵称等信息.

5).发送微信消息

3.运行环境

新用户系统会单独部署到一个服务器上，也有单独开启一个rds实例。考虑到有线上、测试等不同的环境，每个环境会对应服务器上不同端口号的服务实例，
在数据库中对应不用的库名称(_但会使用相同的表名。这是为了可以统一进行sql的编码_)。

==== 二者单独实现的基本用户信息

1.数据库设计

.基础用户信息表
|====
|id|userId|nickName|photo|synopsis|spaceId
|自增主键|24位用户ID|昵称|头像|个人简介|空间ID
|====

a.该表会根据两个产品的不同分别做调整。

b.后续每个产品有特殊的功能会单独设计实现

c.将操作该表的代码移至api项目中

.dbc_verifcode

a.该表记录用户所发过的验证码，暂时保持不变

.dbc_user_wechat/dbc_third

a.这两张表均用来记录userId-openId-appId-unionId的关系，统一整合到公共系统的wechat表中。
原有dbc_user_wechat表中的数据添加　数据道　公众号对应的appId。

2.需求修改

a.用户通过A平台注册后，B平台中采取“懒人式”用户初始化行为。
　其中，公共用户系统所提供的微信登录的接口中，也采用懒人式初始化。具体见上一部分中的设计

|====
|A平台通过账号密码注册|公共用户系统创建用户|B平台登录后，查询到B平台没有该用户的信息，此时默认初始化昵称和头像等信息
|A平台通过wechat注册|公共用户系统创建用户|B平台登录后，查询到B平台没有该用户的信息，此时读取微信的昵称头像对用户信息进行初始化
|====

b.在userSession及一些列获取用户信息的接口的返回值结构DbcUser中，
将与登录有关的 *账号、手机号、邮箱、微信名* 信息删除。

... session中缓存的结构也没有这些信息了；
... 单独增加根据用户ID/当前用户获取登录相关信息的接口;

c.更新用户信息的接口由现在的一个拆分成两个。一个用于更新用户的基本信息，另一个用于更新用户绑定的可登陆信息；

d.微信登录的接口：

|====
|接口url|使用场景|调用公共平台接口
|loginByWechat|数据道微信版网页版登录时调用|开放平台的wechatLogin
|loginByWechat/application|数据道应用公众号的登录，目前只用于产品目录|开放平台的wechatLogin
|third/wechat/login|通过数据道应用公众号登录，目前用于眼镜店系统的登录，包含特殊的用户初始化逻辑，并非通用流程|开放平台的wechatLogin
|third/wechat/small/login|小程序登录|*非开放平台的wechatLogin*
|====

=== 其他
. dynamoDB表名，s3桶名均需要重新设计

== 服务器部署方案

=== 现有服务器情况

. 线上环境
.. (api+dbc)主业务服务器 * 2
.. redis 服务器 * 1
.. solr 服务器 * 1
.. rds 服务器 * 1
.. 负载均衡器 * 1
.. dynamoDB表 * 4
.. s3存储桶若干
.. 七牛图片存储

* 共计4个云服务器,1个rds服务器，1个负载均衡器

. 测试环境
现有两套测试环境
.. test1
主业务服务器 * 1
redis+solr 服务器 * 1
rds 服务器 * 1
dynamoDB表 * 4
s3存储桶若干(与线上共享)

* 共计3个云服务器,1个rds服务器

.. test2
主业务+redis+solr 服务器 * 1
rds 服务器 * 1
dynamoDB表 * 4
s3存储桶若干(与线上共享)

* 共计2个云服务器,1个rds服务器

=== 部署计划

. 线上环境

  新增一整套配置，dynamoDB的表、s3存储通通过名称区分。

. 新用户系统

  方案如之前运行环境中所述。

. 测试环境方案有待商讨
