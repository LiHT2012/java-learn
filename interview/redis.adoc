redis是单线程的.redis的命令都是原子操作

AOF 持久化的原理
理论上说，只要我们保存了所有可能修改 Redis 内存数据的命令（也就是写命令），那么根据这些保存的写命令，我们可以重新恢复 Redis 的内存状态。
AOF 持久化正是利用这个原理来实现数据的持久化与数据的恢复的.
https://blog.csdn.net/lihao21/article/details/75269622
AOF 的优点
AOF 持久化的方法提供了多种的同步频率，即使使用默认的同步频率每秒同步一次，Redis 最多也就丢失 1 秒的数据而已。
AOF 文件使用 Redis 命令追加的形式来构造，因此，即使 Redis 只能向 AOF 文件写入命令的片断，使用 redis-check-aof 工具也很容易修正 AOF 文件。
AOF 文件的格式可读性较强，这也为使用者提供了更灵活的处理方式。例如，如果我们不小心错用了 FLUSHALL 命令，在重写还没进行时，我们可以手工将最后的 FLUSHALL 命令去掉，
然后再使用 AOF 来恢复数据。
AOF 的缺点
对于具有相同数据的的 Redis，AOF 文件通常会比 RDB 文件体积更大。
虽然 AOF 提供了多种同步的频率，默认情况下，每秒同步一次的频率也具有较高的性能。但在 Redis 的负载较高时，RDB 比 AOF 具好更好的性能保证。
RDB 使用快照的形式来持久化整个 Redis 数据，而 AOF 只是将每次执行的命令追加到 AOF 文件中，因此从理论上说，RDB 比 AOF 方式更健壮。官方文档也指出，AOF 的确也存在一些 BUG，
这些 BUG 在 RDB 没有存在。


为此，Redis 提供了两种不同的持久化方法来将数据存储到硬盘里面。一种方法叫做快照（snapshotting），它可以将存在于某一时刻的所有数据写入硬盘里面。
另一种方法叫 AOF（append-only file），它会在执行写命令时，将被执行的写命令复制到硬盘里面。这种两持久化方法既可以同时使用，也可以单独使用，
当然如果 Redis 单纯只作为缓存系统使用的话，也可以两种持久化方法都不使用。具体选择哪种持久化方法取决于用户的应用场景。

Redis 将某一时刻的快照保存成一种称为 RDB 格式的文件中。RDB 文件是一个经过压缩的二进制文件，通过该文件，Redis 可以将内存中的数据恢复成某一时刻的状态。

解决redis aof文件过大的问题( AOF（Append Only File）持久化功能)
执行BGREWRITEAOF命令对redis的AOF进行重写

redis-cli BGREWRITEAOF

相关解释：

Redis的AOF机制有点类似于Mysql binlog，是Redis的提供的一种持久化方式（另一种是RDB），它会将所有的写命令按照一定频率(no, always, every seconds)写入到日志文件中，当Redis停机重启后恢复数据库。

AOF重写：
(1) 随着AOF文件越来越大，里面会有大部分是重复命令或者可以合并的命令（100次incr = set key 100）
(2) 重写的好处：减少AOF日志尺寸，减少内存占用，加快数据库恢复时间。

执行一个 AOF文件重写操作，重写会创建一个当前 AOF 文件的体积优化版本。
即使 BGREWRITEAOF 执行失败，也不会有任何数据丢失，因为旧的 AOF 文件在 BGREWRITEAOF 成功之前不会被修改。
从 Redis 2.4 开始，AOF 重写由 Redis 自行触发， BGREWRITEAOF 仅仅用于手动触发重写操作。但网上有网友说已经3.2.5版本了，貌似redis还是没有自动触发BGREWRITEAOF
稳妥的方法还写一个脚本每天定时去执行.

Redis如何控制AOF大小
随着命令不断写入AOF，文件会越来越大，为了解决这个问题，redis引入了AOF重写机制压缩文件。文件能缩小的原因是：
1.旧文件中的无效命令不会保留，如del key1,sort。
2.多条合并成一条,如lplush list a,lplush list b转换为lplush a b，也可以合并重复项。
AOF重写可以手动触发和自动触发：
1.手动触发可以调用bgrewriteaof。
2.根据如下两个参数自动触发。
redis.conf
#代表当前AOF文件空间和上次重写后AOF空间的比值。
auto-aof-rewrite-percentage 100
#AOP超过10m就开始收缩
auto-aof-rewrite-min-size 10mb

当Redis在做AOF持久化时，会出现AOF文件重写（以减少持久化文件的大小）的操作，这个时候会直接读取Redis数据库中的数据进行操作，会把Redis数据库中存在的键值对写入到AOF重写文件
中，这个时候常常会出现如下情况：用户在这个AOF重写过程中对数据库进行了写入或者修改的操作。
Redis的解决方法：
由于AOF的重写是由Redis主线程之外一个子线程执行，是在AOF写入的时候，会重新建立一个AOF重写缓冲区，当用户对数据库进行操作时，会把用户的操作追加到AOF重写缓冲区和AOF缓冲区中，
此时AOF文件写入操作会同时从AOF缓冲区和AOF重写缓冲区两个地方读入数据，这样就保证了用户的添加修改操作的不丢失。
